<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>WebAR - Mobile Ready</title>
    <!-- This viewport tag is critical for mobile compatibility -->
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
            background-color: #000; /* Explicitly set background */
        }

        #overlay {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            z-index: 10;
            text-align: center;
            padding: 1.5rem;
            cursor: pointer;
            transition: opacity 0.5s ease;
        }

        /* Class to hide the overlay */
        #overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        #overlay-content {
            background: rgba(30, 30, 30, 0.8);
            padding: 2rem;
            border-radius: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 400px;
        }
        
        #overlay h1 { font-size: 1.5rem; margin: 0 0 0.5rem 0; font-weight: 700; }
        #overlay p { margin: 0; font-size: 1rem; color: #ccc; }

        #info {
            position: fixed;
            left: 12px;
            bottom: 12px;
            color: #fff;
            background: rgba(0,0,0,0.5);
            padding: 6px 10px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 13px;
            z-index: 11;
        }
    </style>

    <!-- Using CDN for Three.js to ensure it's always available -->
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.164.1/build/three.module.js",
            "GLTFLoader": "https://cdn.jsdelivr.net/npm/three@0.164.1/examples/jsm/loaders/GLTFLoader.js"
        }
    }
    </script>
</head>

<body>
    <div id="overlay">
        <div id="overlay-content">
            <h1>Start Augmented Reality</h1>
            <p>Tap anywhere to begin.<br>Point your camera at the Hiro marker.</p>
        </div>
    </div>
    <div id="info">Initializing...</div>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'GLTFLoader';

        window.THREE = THREE; // Expose THREE for ar-threex.js

        // --- Global variables ---
        let scene, camera, renderer, arToolkitSource, arToolkitContext, markerRoot, loadedModel;
        const clock = new THREE.Clock();

        // --- Load AR.js dynamically ---
        const arScript = document.createElement('script');
        arScript.src = 'https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar-threex.js';
        document.head.appendChild(arScript);
        
        arScript.onload = () => {
            // After the AR library is loaded, set up the initial scene
            initScene();
        };
        
        function initScene() {
            scene = new THREE.Scene();
            camera = new THREE.Camera(); // AR.js will manage this camera's projection
            scene.add(camera);

            renderer = new THREE.WebGLRenderer({ antiasias: true, alpha: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);
            
            // --- Improved Lighting ---
            scene.add(new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1.5));
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(0.5, 1, 0.7).normalize();
            scene.add(directionalLight);

            // Set up a root group for the marker content
            markerRoot = new THREE.Group();
            scene.add(markerRoot);
            
            // Load the 3D model
            loadModel();

            // Setup UI
            document.getElementById('info').innerText = 'Please tap screen to start';
            const overlay = document.getElementById('overlay');
            overlay.addEventListener('click', () => {
                overlay.classList.add('hidden'); // Use class to hide overlay smoothly
                startAR();
            });
        }

        async function startAR() {
            document.getElementById('info').innerText = 'Starting camera...';

            arToolkitSource = new THREEx.ArToolkitSource({ sourceType: 'webcam', sourceWidth: window.innerWidth, sourceHeight: window.innerHeight });
            arToolkitContext = new THREEx.ArToolkitContext({
                cameraParametersUrl: 'https://raw.githack.com/AR-js-org/AR.js/master/data/data/camera_para.dat',
                detectionMode: 'mono',
            });

            arToolkitSource.init(() => {
                // Use a timeout to ensure the video element is ready before the first resize.
                setTimeout(() => onResize(), 500);
            });
            window.addEventListener('resize', onResize);
            
            await arToolkitContext.init();
            
            camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());
            
            // --- Marker Controls ---
            new THREEx.ArMarkerControls(arToolkitContext, markerRoot, {
                type: 'preset',
                preset: 'hiro',
            });

            // Start the render loop
            render();
        }

        function loadModel() {
            const gltfLoader = new GLTFLoader();
            gltfLoader.load(
                'https://raw.githack.com/AR-js-org/AR.js/master/aframe/examples/image-tracking/nft/trex/scene.gltf', 
                (gltf) => {
                    loadedModel = gltf.scene;
                    loadedModel.scale.set(0.1, 0.1, 0.1);
                    loadedModel.position.y = 0; // Model sits on the marker
                    markerRoot.add(loadedModel);
                    console.log('GLTF model loaded.');
                },
                undefined,
                (error) => { console.error('Error loading GLTF model:', error); }
            );
        }

        function onResize() {
            arToolkitSource.onResizeElement();
            arToolkitSource.copyElementSizeTo(renderer.domElement);
            if (arToolkitContext.arController !== null) {
                arToolkitSource.copyElementSizeTo(arToolkitContext.arController.canvas);
            }
        }
            
        function render() {
            requestAnimationFrame(render);
            if (arToolkitSource && arToolkitSource.ready) {
                arToolkitContext.update(arToolkitSource.domElement);
                scene.visible = camera.visible;
            }

            // Animate the model when it's loaded and the marker is visible
            if (loadedModel && markerRoot.visible) {
                loadedModel.rotation.y += clock.getDelta() * 0.5;
            }
            
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>

