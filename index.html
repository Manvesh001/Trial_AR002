<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>WebAR - Mobile Ready</title>
    <!-- This viewport tag is critical for mobile compatibility -->
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
        }

        #overlay {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            z-index: 10;
            text-align: center;
            padding: 1.5rem;
            cursor: pointer;
            transition: opacity 0.5s ease;
        }

        #overlay-content {
            background: rgba(30, 30, 30, 0.8);
            padding: 2rem;
            border-radius: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 400px;
        }
        
        #overlay h1 { font-size: 1.5rem; margin: 0 0 0.5rem 0; font-weight: 700; }
        #overlay p { margin: 0; font-size: 1rem; color: #ccc; }

        #info {
            position: fixed;
            left: 12px;
            bottom: 12px;
            color: #fff;
            background: rgba(0,0,0,0.5);
            padding: 6px 10px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 13px;
            z-index: 11;
        }
    </style>

    <!-- Using CDN for Three.js to ensure it's always available -->
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.164.1/build/three.module.js",
            "GLTFLoader": "https://cdn.jsdelivr.net/npm/three@0.164.1/examples/jsm/loaders/GLTFLoader.js"
        }
    }
    </script>
</head>

<body>
    <div id="overlay">
        <div id="overlay-content">
            <h1>Start Augmented Reality</h1>
            <p>Tap anywhere to begin.<br>Point your camera at the Hiro marker.</p>
        </div>
    </div>
    <div id="info">Initializing AR...</div>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'GLTFLoader';

        window.THREE = THREE;

        // --- Dynamically load AR.js to ensure THREE is ready first ---
        const arScript = document.createElement('script');
        arScript.src = 'https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar-threex.js';
        document.head.appendChild(arScript);
        arScript.onload = main;

        async function main() {
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            scene.add(camera);

            const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);
            
            // --- Lighting ---
            scene.add(new THREE.AmbientLight(0xdddddd));
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(1, 1, 1).normalize();
            scene.add(directionalLight);
            
            // --- AR.js Setup ---
            const arToolkitSource = new THREEx.ArToolkitSource({ sourceType: 'webcam' });
            const arToolkitContext = new THREEx.ArToolkitContext({
                cameraParametersUrl: 'https://raw.githack.com/AR-js-org/AR.js/master/data/data/camera_para.dat',
                detectionMode: 'mono',
            });

            // --- Robust Resize Handler ---
            function onResize() {
                arToolkitSource.onResizeElement();
                arToolkitSource.copyElementSizeTo(renderer.domElement);
                if (arToolkitContext.arController !== null) {
                    arToolkitSource.copyElementSizeTo(arToolkitContext.arController.canvas);
                }
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }

            arToolkitSource.init(onResize);
            window.addEventListener('resize', onResize);
            
            await arToolkitContext.init();
            
            camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());
            camera.matrixAutoUpdate = false; // Important: AR.js will manage the camera matrix

            // --- Marker Setup ---
            const markerRoot = new THREE.Group();
            scene.add(markerRoot);
            
            new THREEx.ArMarkerControls(arToolkitContext, camera, {
                type: 'preset',
                preset: 'hiro',
                markerMatrixType: 'world',
            });

            // --- Scene Content ---
            const infoDiv = document.getElementById('info');
            infoDiv.innerText = 'Point camera at the HIRO marker';
            
            const gltfLoader = new GLTFLoader();
            gltfLoader.load(
                // IMPORTANT: Using a remotely hosted model to avoid local file errors.
                // Replace this URL with the URL of your own model hosted on GitHub or another service.
                'https://raw.githack.com/AR-js-org/AR.js/master/aframe/examples/image-tracking/nft/trex/scene.gltf', 
                (gltf) => {
                    const gltfModel = gltf.scene;
                    gltfModel.scale.set(0.1, 0.1, 0.1); // Adjust scale to fit the model
                    gltfModel.position.y = 0; // Adjust position to sit on the marker
                    markerRoot.add(gltfModel);
                    infoDiv.innerText = 'Model loaded! Marker ready.';
                    console.log('GLTF model loaded successfully.');
                },
                undefined,
                (error) => {
                    console.error('An error happened while loading the GLTF model:', error);
                    infoDiv.innerText = 'Error: Could not load 3D model.';
                }
            );

            // --- UI Interaction ---
            const overlay = document.getElementById('overlay');
            overlay.addEventListener('click', () => {
                overlay.style.opacity = '0';
                setTimeout(() => { overlay.style.display = 'none'; }, 500);
                console.log("UI unlocked, AR starting.");
                // To re-enable sound, uncomment the line below and make sure
                // the sound file is hosted online with a full URL.
                // new Audio('FULL_URL_TO_YOUR/click.wav').play().catch(()=>{});
            });
            
            // --- Render Loop ---
            const clock = new THREE.Clock();
            function render() {
                requestAnimationFrame(render);

                if (arToolkitSource.ready === false) return;
                
                arToolkitContext.update(arToolkitSource.domElement);
                camera.updateMatrixWorld(true);

                // Animate the model when the marker is visible
                if (markerRoot.children.length > 0) { // Check if model is added
                     markerRoot.children[0].rotation.y += clock.getDelta() * 0.5;
                }
                
                renderer.render(scene, camera);
            }
            render();
        }
    </script>
</body>
</html>

